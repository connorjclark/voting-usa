<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
  <script src="third_party/jquery.usmap.js"></script>

  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.5.3/dist/js/tabulator.min.js"></script>
  <link href="https://unpkg.com/tabulator-tables@4.5.3/dist/css/tabulator.min.css" rel="stylesheet">

  <link rel="preload" href="data/data.json">
</head>

<body>
  <div id="map"></div>
  <div id="table"></div>
  <div id="sources"></div>

  <script>
    async function main() {
      const data = await fetch('data/data.json').then(r => r.json());

      const stateSpecificStyles = {};
      for (const state of data.states) {
        let fill;
        if (state.score >= 4) fill = 'green';
        else if (state.score >= 2) fill = 'yellow';
        else fill = 'red';
        stateSpecificStyles[state.abbreviation] = { fill };
      }

      $('#map').usmap({
        stateSpecificStyles,
      });

      const tableEl = document.querySelector('#table');
      const categoryCol = {
        sorter: (a, b) => a.score - b.score,
        formatter: cell => {
          let val = '';

          val += cell.getValue().score;
          if (cell.getValue().tags.length) {
            val += ` (${cell.getValue().tags.join(', ')})`;
          }
          if (cell.getValue().notes) {
            val += '*';
          }

          return val;
        },
      };
      const table = new Tabulator(tableEl, {
        data: data.states, // load row data from array
        height: '100%',
        layout: 'fitColumns', // fit columns to width of table
        tooltips: cell => {
          if (!cell.getValue() || !cell.getValue().notes) return false;
          return cell.getValue().notes;
        },
        addRowPos: 'top', // when adding a new row, add it to the top of the table
        history: true, // allow undo and redo actions on the table
        resizableRows: true, // allow row order to be changed
        initialSort: [ // set the initial sort order of the data
          { column: 'score', dir: 'desc' },
        ],
        columns: [ // define the table columns
          { title: 'Name', field: 'name' },
          { title: 'Score', field: 'score', align: 'left' },
          { title: 'Vote By Mail', field: 'voteByMail', ...categoryCol },
          { title: 'Voting Centers', field: 'votingCenters', ...categoryCol },
          { title: 'Ranked Choice', field: 'rankedChoice', ...categoryCol },
          { title: 'Same Day Registration', field: 'sameDayRegistration', ...categoryCol },
        ],
      });

      document.querySelector('#sources').innerHTML = data.sources.map(source => `${source.name}:<br>${source.text.replace(/\n/g, '<br>')}`).join('<br><br>');
    }

    main();
  </script>
</body>

</html>